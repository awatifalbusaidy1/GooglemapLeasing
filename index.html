<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google Maps Qatar</title>

  <link rel="stylesheet" href="style.css" />

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDPJsDKW08BaA8Am1CCoVGum6jOgcF893Q&callback=initMap"
    async defer>
  </script>
</head>

<body>
  <div class="search-wrap">
    <input id="search-box" type="text" placeholder="Search a project" autocomplete="off" />
    <div id="suggestions" class="suggestions"></div>
  </div>

  <div id="map"></div>

  <div id="guide-box">
    <h3>Pin Guide</h3>
    <div class="guide-item">
      <img src="images/leasing.png" alt="Leasing Icon" /> Leasing
    </div>
  </div>

<script>
let map;
let markers = [];   // { marker, infoWindow, pin, title }
let allPins = [];
let activeIndex = -1;
let lastAutoOpenedTitle = "";

// ✅ Close any open popup
function closeAllPopups() {
  markers.forEach((m) => m.infoWindow.close());
}

// ✅ Normalize text for better search (BO4, OA1, VB23, etc.)
function normalizeText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/\s+/g, " ")
    .trim();
}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 25.276987, lng: 51.520008 },
    zoom: 9,
    mapTypeId: "roadmap",
    zoomControl: false,
    streetViewControl: false,
  });

  fetch("pins.json")
    .then((r) => r.json())
    .then((data) => {
      allPins = data.pins || [];
      allPins.forEach((pin) => addMarker(pin));
    })
    .catch((err) => console.error("Failed to load pins.json:", err));

  const input = document.getElementById("search-box");
  input.addEventListener("input", onSearchInput);
  input.addEventListener("keydown", onSearchKeyDown);

  // Close suggestions when clicking outside
  document.addEventListener("click", (e) => {
    const wrap = document.querySelector(".search-wrap");
    if (wrap && !wrap.contains(e.target)) hideSuggestions();
  });
}

function addMarker(pin) {
  const icons = {
    sale: { url: "images/sales.png", scaledSize: new google.maps.Size(50, 50) },
    lease: { url: "images/leasing.png", scaledSize: new google.maps.Size(30, 30) },
    propertymanagement: { url: "images/propertymanagement.png", scaledSize: new google.maps.Size(30, 30) },
    thirdparty: { url: "images/thirdparty.png", scaledSize: new google.maps.Size(30, 30) },
  };

  const typeKey = (pin.type || "").toLowerCase();

  const marker = new google.maps.Marker({
    position: { lat: pin.lat, lng: pin.lng },
    map,
    icon: icons[typeKey] || icons.lease,
    title: pin.title || "",
  });

  const infoWindow = new google.maps.InfoWindow({
  content: `
    <div style="max-width: 320px; font-family: Arial, sans-serif;">
      <img src="${pin.image || ""}" alt="${escapeHtml(pin.title || "")}"
        style="width:100%; height:auto; border-radius: 8px; display:block;">

      <h3 style="margin: 12px 0 8px; font-size: 18px;">
        ${escapeHtml(pin.title || "")}
      </h3>

      <p style="margin: 6px 0; font-size: 14px;">
        <b>Location:</b> ${escapeHtml(pin.description || pin.location || "")}
      </p>

      <div style="margin: 8px 0; font-size: 14px;">
        ${pin.price || ""}
      </div>

      <p style="margin: 6px 0; font-size: 14px;">
        <b>Famous Landmark:</b> ${escapeHtml(pin.landmarks || pin.landmark || "")}
      </p>

      ${
        pin.link
          ? `<a href="${pin.link}" target="_blank"
              style="display:inline-block; margin-top:8px; color: #1a73e8; text-decoration: underline; font-size: 14px;">
              Project in Salesforce
            </a>`
          : ""
      }
    </div>
  `,
});


  // click marker => open popup
  marker.addListener("click", () => {
    openProjectPopup({ marker, infoWindow, pin });
  });

  // Optional label marker (uses pin.landmark if present)
  if (pin.landmark) {
    new google.maps.Marker({
      position: { lat: pin.lat + 0.001, lng: pin.lng },
      map,
      icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
      label: {
        text: pin.landmark,
        color: "#000",
        fontSize: "12px",
        fontWeight: "bold",
      },
    });
  }

  markers.push({
    marker,
    infoWindow,
    pin,
    title: normalizeText(pin.title),
  });
}

// ✅ open popup directly (reliable)
function openProjectPopup(found) {
  closeAllPopups();
  found.marker.setVisible(true);
  map.panTo(found.marker.getPosition());
  map.setZoom(18);
  found.infoWindow.open(map, found.marker);

  // Style close button after it appears (your original style)
  setTimeout(() => {
    const closeButton = document.querySelector(".gm-ui-hover-effect");
    if (closeButton) {
      closeButton.style.backgroundColor = "white";
      closeButton.style.borderRadius = "50%";
      closeButton.style.width = "25px";
      closeButton.style.height = "25px";
      closeButton.style.display = "flex";
      closeButton.style.alignItems = "center";
      closeButton.style.justifyContent = "center";
      closeButton.style.boxShadow = "0 2px 5px rgba(0, 0, 0, 0.2)";

      const closeIcon = closeButton.querySelector("img");
      if (closeIcon) closeIcon.remove();

      closeButton.innerHTML = "✖";
      closeButton.style.fontSize = "16px";
      closeButton.style.fontWeight = "bold";
      closeButton.style.color = "black";
      closeButton.style.cursor = "pointer";
    }
  }, 200);
}

// ---------------- Autocomplete Suggestions (SMART SEARCH) ----------------
function onSearchInput(e) {
  const raw = e.target.value.trim();

  // ✅ If empty: show all markers, reset map, and CLOSE popup
  if (!raw) {
    markers.forEach((m) => m.marker.setVisible(true));
    closeAllPopups();
    map.setCenter({ lat: 25.276987, lng: 51.520008 });
    map.setZoom(9);
    hideSuggestions();
    lastAutoOpenedTitle = "";
    return;
  }

  const q = normalizeText(raw);
  const qCompact = q.replace(/[\s-]/g, ""); // remove spaces & dashes

  // ✅ match anywhere (so BO4 finds "Bin Omran 28 - BO4")
  const matches = allPins
    .filter((p) => {
      const t = normalizeText(p.title);
      const tCompact = t.replace(/[\s-]/g, "");
      return t.includes(q) || tCompact.includes(qCompact);
    })
    .slice(0, 8);

  // Show/hide markers based on includes
  markers.forEach((m) => {
    const t = m.title;
    const tCompact = t.replace(/[\s-]/g, "");
    m.marker.setVisible(t.includes(q) || tCompact.includes(qCompact));
  });

  renderSuggestions(matches);

  // ✅ Auto-open popup when:
  // - exact match exists, OR
  // - only 1 match remains
  if (!matches.length) return;

  const exact = matches.find((p) => normalizeText(p.title) === q);
  const candidate = exact || (matches.length === 1 ? matches[0] : null);

  if (candidate) {
    const candidateTitle = normalizeText(candidate.title);
    if (lastAutoOpenedTitle !== candidateTitle) {
      lastAutoOpenedTitle = candidateTitle;
      selectProjectByTitle(candidate.title);
    }
  }
}

function renderSuggestions(items) {
  const box = document.getElementById("suggestions");
  activeIndex = -1;

  if (!items.length) {
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }

  box.innerHTML = items
    .map(
      (p, idx) => `
        <div class="suggestion-item" data-index="${idx}">
          ${escapeHtml(p.title || "")}
        </div>
      `
    )
    .join("");

  box.style.display = "block";

  box.querySelectorAll(".suggestion-item").forEach((el) => {
    el.addEventListener("click", () => {
      const title = el.textContent.trim();
      selectProjectByTitle(title);
    });
  });
}

function onSearchKeyDown(e) {
  const box = document.getElementById("suggestions");
  if (box.style.display !== "block") return;

  const items = Array.from(box.querySelectorAll(".suggestion-item"));
  if (!items.length) return;

  if (e.key === "ArrowDown") {
    e.preventDefault();
    activeIndex = (activeIndex + 1) % items.length;
    setActive(items);
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    activeIndex = (activeIndex - 1 + items.length) % items.length;
    setActive(items);
  } else if (e.key === "Enter") {
    e.preventDefault();
    if (activeIndex >= 0) items[activeIndex].click();
    else selectProjectByTitle(document.getElementById("search-box").value);
  } else if (e.key === "Escape") {
    hideSuggestions();
  }
}

function setActive(items) {
  items.forEach((el, i) => el.classList.toggle("active", i === activeIndex));
  items[activeIndex].scrollIntoView({ block: "nearest" });
}

function selectProjectByTitle(title) {
  const q = normalizeText(title);
  const qCompact = q.replace(/[\s-]/g, "");

  const found =
    markers.find((m) => m.title === q) ||
    markers.find((m) => m.title.includes(q)) ||
    markers.find((m) => m.title.replace(/[\s-]/g, "").includes(qCompact));

  if (!found) return;

  document.getElementById("search-box").value = found.pin.title || "";

  hideSuggestions();
  openProjectPopup(found);
}

function hideSuggestions() {
  const box = document.getElementById("suggestions");
  box.style.display = "none";
  box.innerHTML = "";
  activeIndex = -1;
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;",
  }[m]));
}
</script>
</body>
</html>
